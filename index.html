<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Historial de Inspecciones AENOR</title>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: left; }
        th { background: #4a90e2; color: white; }
        tr:hover { background: #f9f9f9; }
        .btn-excel { background: #27ae60; color: white; padding: 5px 10px; text-decoration: none; border-radius: 4px; font-size: 0.8rem; }
    </style>
</head>
<body>
    <div class="card">
        <h2>üìã Historial de Reportes Guardados</h2>
        <table id="tablaHistorial">
            <thead>
                <tr>
                    <th>Fecha Registro</th>
                    <th>Nombre Site</th>
                    <th>Proyecto</th>
                    <th>Inspector</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <script>
       async function cargarHistorial() {
    const tbody = document.querySelector('#tablaHistorial tbody');
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">Conectando con el servidor en la nube...</td></tr>';

    try {
        // Llamada al endpoint de Render
        const response = await fetch('https://backend-reportes-excel.onrender.com/historial-datos');
        
        if (!response.ok) {
            throw new Error(`Error ${response.status}: El servidor no reconoce la ruta de historial.`);
        }

        const datos = await response.json();
        tbody.innerHTML = ''; // Limpiamos el mensaje de carga

        if (datos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">No hay inspecciones registradas a√∫n.</td></tr>';
            return;
        }

        datos.forEach(reg => {
            // Formateamos la fecha para que sea legible
            const fecha = new Date(reg.fecha_registro).toLocaleString('es-PE');
            
            tbody.innerHTML += `
                <tr>
                    <td>${fecha}</td>
                    <td>${reg.nombre_site || 'N/A'}</td>
                    <td>${reg.proyecto || 'N/A'}</td>
                    <td>${reg.inspector_nombre || 'N/A'}</td>
                    <td>
                        <button onclick="descargarCopia(${reg.id})" style="background:#27ae60; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer">
                            üì• Excel
                        </button>
                    </td>
                </tr>`;
        });
    } catch (error) {
        console.error("Error cr√≠tico:", error);
        tbody.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center">‚ö†Ô∏è Error: ${error.message}<br>Revisa que el backend en Render est√© activo.</td></tr>`;
    }
}

function descargarCopia(id) {
    // Redirige al endpoint de regeneraci√≥n
    window.location.href = `https://backend-reportes-excel.onrender.com/regenerar-excel/${id}`;
}

window.onload = cargarHistorial;
    </script>
</body>
</html>
